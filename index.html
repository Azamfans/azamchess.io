<?php
session_start();
if (!isset($_SESSION['username'])) { header("Location: login.php"); exit; }
include 'koneksi.php';
$user_aktif = $_SESSION['username'];

// Link Foto Ikon
$bot_mudah_img = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT6-mXmX_YwS8B4-P0r5xXw6f_y-F4-w3-Rvg&s"; // Tom Hanks
$bot_sulit_img = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS8X3z-Y9yU6R9mX7E6U6F1Y7Y6H_T1U6R9mQ&s"; // Magnus
?>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>AZAM CHESS - Official Website</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #81b64c;
            --bg-dark: #262522;
            --bg-sidebar: #21201d;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1920&q=80') center/cover fixed;
            margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: -1; }

        .container {
            display: grid;
            grid-template-columns: 600px 350px;
            gap: 20px;
            background: var(--bg-dark);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        /* LOGO STYLING */
        .logo-container {
            text-align: center;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--primary);
            margin-bottom: 20px;
        }
        .logo-text {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 0;
            text-shadow: 2px 2px 10px rgba(129, 182, 76, 0.5);
        }

        /* BOARD AREA */
        .board-area { width: 100%; }
        .player-info {
            display: flex; align-items: center; gap: 15px;
            padding: 10px; background: rgba(255,255,255,0.05);
            border-radius: 8px; margin-bottom: 10px; position: relative;
        }
        .avatar-img { width: 55px; height: 55px; border-radius: 8px; border: 2px solid #444; object-fit: cover; }
        .bubble {
            position: absolute; left: 80px; top: -10px; background: white; color: black;
            padding: 8px 12px; border-radius: 10px; font-size: 13px; font-weight: bold;
            display: none; z-index: 100;
        }

        #board { border: 4px solid #312e2b; border-radius: 5px; }

        /* SIDEBAR AREA */
        .sidebar { background: var(--bg-sidebar); padding: 20px; border-radius: 10px; color: white; }
        .status-card {
            background: #1a1917; padding: 15px; text-align: center;
            border-radius: 8px; border-bottom: 4px solid var(--primary);
            font-size: 18px; margin-bottom: 20px;
        }

        select, button {
            width: 100%; padding: 14px; border-radius: 8px; border: none;
            font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s;
        }
        .btn-green { background: var(--primary); color: white; }
        .btn-green:hover { background: #a3d160; }
        .btn-dark { background: #3d3a37; color: #bababa; }
        .btn-dark:hover { color: white; background: #4d4a47; }

        .history-table { width: 100%; font-size: 12px; margin-top: 20px; border-collapse: collapse; }
        .history-table td { padding: 8px; border-bottom: 1px solid #333; }
        
        /* CHESS PIECE COLORS */
        .white-1e1d7 { background-color: #ebecd0 !important; }
        .black-3c85d { background-color: #779556 !important; }
    </style>
</head>
<body onclick="startMusic()">

<div class="overlay"></div>

<div class="container">
    <div class="board-area">
        <div class="player-info" id="botBox">
            <img id="botAvatar" src="1993 Best Actor - _Philadelphia_.jpg" class="avatar-img">
            <div id="botBubble" class="bubble"></div>
            <div>
                <div id="botName" style="font-weight: 600; color: white; font-size: 18px;">Tom Hanks</div>
                <div id="botStatus" style="font-size: 12px; color: var(--primary);">Casual Level (Rating 600)</div>
            </div>
        </div>

        <div id="board"></div>

        <div class="player-info" style="margin-top: 10px;">
            <img src="WhatsApp Image 2026-01-16 at 04.36.52 (1).jpeg" class="avatar-img">
            <div>
                <div style="font-weight: 600; color: white;"><?php echo $user_aktif; ?> (Anda)</div>
                <div style="font-size: 12px; color: #888;">Player Putih</div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo-container">
            <h1 class="logo-text">AZAM CHESS</h1>
        </div>

        <div class="status-card" id="status">Giliran Putih</div>

        <div class="menu-box">
            <label style="font-size: 11px; color: #aaa;">KESULITAN</label>
            <select id="botLevel" onchange="updateBotProfile()" style="background: #312e2b; color: white; padding: 10px; border: 1px solid #444;">
                <option value="Mudah">Tom Hanks (Mudah)</option>
                <option value="Sulit">Magnus Carlsen (Sulit)</option>
            </select>

            <button class="btn-green" onclick="location.reload()">ðŸ”„ GAME BARU</button>
            <button id="musicBtn" class="btn-dark" onclick="toggleMusic()">ðŸŽµ MUSIK: OFF</button>
            <button class="btn-dark" onclick="showHint()">ðŸ’¡ PETUNJUK</button>
        </div>

        <table class="history-table">
            <tr><td colspan="2" style="font-weight: bold; color: var(--primary);">HISTORY</td></tr>
            <?php
            $res = $conn->query("SELECT * FROM riwayat_permainan ORDER BY id DESC LIMIT 4");
            while($row = $res->fetch_assoc()) {
                echo "<tr><td>{$row['username']}</td><td style='text-align:right;'>{$row['pemenang']}</td></tr>";
            }
            ?>
        </table>
    </div>
</div>

<audio id="bgMusic" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"></audio>
<audio id="sndMove" src="https://images.chesscomfiles.com/chess-themes/sounds/_standard/move-self.mp3"></audio>
<audio id="sndCapture" src="https://images.chesscomfiles.com/chess-themes/sounds/_standard/capture.mp3"></audio>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    var board = null;
    var game = new Chess();
    var music = document.getElementById("bgMusic");
    var synth = window.speechSynthesis;

    function startMusic() {
        if(music.paused) {
            music.volume = 0.2;
        }
    }

    function toggleMusic() {
        if(music.paused) {
            music.play();
            $('#musicBtn').text('ðŸŽµ MUSIK: ON').css('color', '#81b64c');
        } else {
            music.pause();
            $('#musicBtn').text('ðŸŽµ MUSIK: OFF').css('color', '#bababa');
        }
    }

    function updateBotProfile() {
        const lvl = $('#botLevel').val();
        if(lvl === "Sulit") {
            $('#botAvatar').attr('src', "<?php echo $bot_sulit_img; ?>");
            $('#botName').text('Magnus Carlsen');
            $('#botStatus').text('World Champion (Rating 2850)').css('color', '#ff4d4d');
            botSpeak("You have no chance against the world champion.");
        } else {
            $('#botAvatar').attr('src', "<?php echo $bot_mudah_img; ?>");
            $('#botName').text('Tom Hanks');
            $('#botStatus').text('Casual Level (Rating 600)').css('color', '#81b64c');
            botSpeak("Life is like a box of chocolates, Azam.");
        }
    }

    function botSpeak(msg) {
        if(synth.speaking) synth.cancel();
        const utter = new SpeechSynthesisUtterance(msg);
        const lvl = $('#botLevel').val();
        
        // Custom Voice Settings
        if(lvl === "Sulit") { utter.pitch = 1.0; utter.rate = 1.1; } // Magnus
        else { utter.pitch = 0.7; utter.rate = 0.8; } // Tom Hanks

        utter.lang = 'en-US';
        synth.speak(utter);
        $('#botBubble').text(msg).fadeIn().delay(3000).fadeOut();
    }

    function onDrop(source, target) {
        const move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';

        if(move.flags.includes('c')) document.getElementById('sndCapture').play();
        else document.getElementById('sndMove').play();

        updateStatus();
        window.setTimeout(makeMove, 600);
    }

    function makeMove() {
        if (game.game_over()) return;
        const moves = game.moves();
        const lvl = $('#botLevel').val();
        let move;

        if(lvl === "Sulit") {
            const captures = game.moves({verbose: true}).filter(m => m.flags.includes('c'));
            move = captures.length > 0 ? captures[0].san : moves[Math.floor(Math.random() * moves.length)];
        } else {
            move = moves[Math.floor(Math.random() * moves.length)];
        }

        const res = game.move(move);
        if(res.flags.includes('c')) document.getElementById('sndCapture').play();
        else document.getElementById('sndMove').play();

        board.position(game.fen());
        updateStatus();
    }

    function updateStatus() {
        let status = game.turn() === 'b' ? 'Magnus/Tom sedang berpikir...' : 'Giliranmu';
        if(game.in_checkmate()) {
            status = 'GAME OVER!';
            botSpeak("Checkmate! Good game.");
        }
        $('#status').text(status);
    }

    function showHint() {
        const moves = game.moves({verbose: true});
        const m = moves[0];
        $('.square-' + m.from).css('box-shadow', 'inset 0 0 5px 5px yellow');
        $('.square-' + m.to).css('box-shadow', 'inset 0 0 5px 5px yellow');
        setTimeout(() => $('.square-55d62').css('box-shadow', 'none'), 2000);
    }

    board = Chessboard('board', {
        draggable: true, position: 'start',
        onDrop: onDrop,
        onSnapEnd: () => board.position(game.fen()),
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    });
</script>
</body>
</html>